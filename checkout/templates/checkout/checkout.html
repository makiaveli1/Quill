{% extends 'base.html' %}
{% load static %}
{% load bag_tools %}
{% load crispy_forms_tags %}

{% block extra_css %}
  <!-- Extra CSS Links -->
  <link rel="stylesheet" href="{% static 'checkout/static/checkout/css/checkout.css' %}" />
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
{% endblock %}

{% block content %}
  <div class="container py-5">
    <div class="row">
      <!-- Order Summary Section -->
      <div class="col-lg-6 mb-4">
        <div class="card border-0 shadow">
          <div class="card-body">
            <h3 class="card-title">Order Summary</h3>
            <hr />
            {% for item in bag_items %}
              <!-- Individual Item in Order Summary -->
              <div class="row py-2 align-items-center">
                <div class="col-4">
                  <!-- Product Image -->
                  <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="img-fluid rounded" />
                </div>
                <div class="col-8">
                  <!-- Product Details -->
                  <h5 class="text-secondary">{{ item.product.name }}</h5>
                  <p class="text-muted mb-1">Quantity: {{ item.quantity }}</p>
                  <p class="text-muted">Subtotal: €{{ item.product.price|calc_subtotal:item.quantity }}</p>
                </div>
              </div>
            {% endfor %}
            <hr />
            <div class="text-right mt-2">
              <!-- Grand Total -->
              <h4 class="text-primary">Grand Total: €{{ grand_total|floatformat:2 }}</h4>
            </div>
          </div>
        </div>
      </div>

      <!-- Stripe Public Key (Hidden) -->
      <span id="id_stripe_public_key" style="display: none;">{{ stripe_public_key }}</span>
      <div id="payment-form" data-secret="{{ stripe_client_secret }}"></div>

      <!-- Checkout Form Section -->
      <div class="col-lg-6">
        <div class="card border-0 shadow">
          <div class="card-body">
            <h3 class="card-title">Checkout</h3>
            <hr />
            <form method="POST" id="payment-form">
              {% csrf_token %}
              <!-- Order Form -->
              {{ order_form|crispy }}

              <!-- Payment Section with Stripe Elements -->
              <div class="form-group mt-3">
                <!-- Card Details Input -->
                <label for="card-element">Card Details</label>
                <div id="card-element" class="form-control"></div>
                <div id="card-errors" role="alert" class="text-danger"></div>
              </div>

              <!-- Submit Button -->
              <button id="submit-button" class="btn btn-primary btn-block mt-4" aria-label="complete-order">Complete Order</button>

              {% if user.is_authenticated %}
                <!-- Save Information Checkbox -->
                <div class="custom-control custom-checkbox mt-3">
                  <input type="checkbox" class="custom-control-input" id="id-save-info" name="save-info" checked />
                  <label class="custom-control-label" for="id-save-info">Save this delivery information</label>
                </div>
              {% endif %}
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block postload_js %}
  {{ block.super }}
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    // stripe_elements.js
    
    document.addEventListener('DOMContentLoaded', function () {
      var stripePublicKeyElement = document.getElementById('id_stripe_public_key')
    
      if (!stripePublicKeyElement) {
        console.error('Stripe Public Key element not found!')
        return
      }
    
      var stripePublicKey = stripePublicKeyElement.textContent.trim()
    
      if (!stripePublicKey) {
        console.error('Stripe Public Key is empty!')
        return
      }
    
      var stripe = Stripe(stripePublicKey)
      var elements = stripe.elements()
    
      // Custom styling for Stripe elements
      var style = {
        base: {
          color: '#32325d',
          fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
          fontSmoothing: 'antialiased',
          fontSize: '16px',
          '::placeholder': {
            color: '#aab7c4'
          }
        },
        invalid: {
          color: '#fa755a',
          iconColor: '#fa755a'
        }
      }
    
      // Create an instance of the card element
      var card = elements.create('card', { style: style })
    
      // Add an instance of the card element into the `card-element` div
      card.mount('#card-element')
    
      // Handle real-time validation errors from the card element
      card.on('change', function (event) {
        var displayError = document.getElementById('card-errors')
        if (event.error) {
          displayError.textContent = event.error.message
        } else {
          displayError.textContent = ''
        }
      })
    
      // Handle form submission
      var form = document.getElementById('payment-form')
      if (!form) {
        console.error('Payment form not found!')
        return
      }
    
      form.addEventListener('submit', function (event) {
        event.preventDefault()
    
        // Disable the submit button to prevent repeated clicks
        var submitButton = document.getElementById('submit-button')
        submitButton.disabled = true
    
        var saveInfo = document.getElementById('id-save-info').checked
        var csrfTokenElement = document.getElementsByName('csrfmiddlewaretoken')[0]
    
        if (!csrfTokenElement) {
          console.error('CSRF token input not found!')
          submitButton.disabled = false
          return
        }
    
        var csrfToken = csrfTokenElement.value
        var clientSecret = form.dataset.secret
    
        if (!clientSecret) {
          console.error('Client secret not found in form dataset!')
          submitButton.disabled = false
          return
        }
    
        var postData = {
          csrfmiddlewaretoken: csrfToken,
          client_secret: clientSecret,
          save_info: saveInfo
        }
        var url = '/checkout/cache_checkout_data/'
    
        // Post data to cache_checkout_data view
        fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(postData)
        })
          .then(function (response) {
            if (!response.ok) {
              throw new Error('Network response was not ok.')
            }
            return response.json()
          })
          .then(function (data) {
            // Confirm the card payment
            stripe
              .confirmCardPayment(clientSecret, {
                payment_method: {
                  card: card,
                  billing_details: {
                    name: form.full_name.value,
                    email: form.email.value
                  }
                }
              })
              .then(function (result) {
                if (result.error) {
                  // Show error to your customer
                  var errorElement = document.getElementById('card-errors')
                  errorElement.textContent = result.error.message
                  submitButton.disabled = false
                } else {
                  // The payment has been processed!
                  if (result.paymentIntent.status === 'succeeded') {
                    // Submit the form
                    form.submit()
                  }
                }
              })
          })
          .catch(function (error) {
            // Display error to the customer
            var errorElement = document.getElementById('card-errors')
            errorElement.textContent = error.message
            submitButton.disabled = false
          })
      })
      stripe
        .confirmCardPayment(clientSecret, {
          payment_method: {
            card: card,
            billing_details: {
              name: form.full_name.value,
              email: form.email.value
            }
          }
        })
        .then(function (result) {
          if (result.error) {
            // Handle error
          } else {
            if (result.paymentIntent.status === 'succeeded') {
              // Inject the paymentIntent.id into the form
              var paymentIntentInput = document.createElement('input')
              paymentIntentInput.setAttribute('type', 'hidden')
              paymentIntentInput.setAttribute('name', 'payment_intent_id')
              paymentIntentInput.setAttribute('value', result.paymentIntent.id)
              form.appendChild(paymentIntentInput)
    
              // Then submit the form to the Django server
              form.submit()
            }
          }
        })
    
      // Custom styling for Stripe Elements
      var style = {
        base: {
          color: '#32325d',
          fontFamily: '"Helvetica Neue", Helvetica, sans-serif',
          fontSmoothing: 'antialiased',
          fontSize: '16px',
          '::placeholder': {
            color: '#aab7c4'
          }
        },
        invalid: {
          color: '#fa755a',
          iconColor: '#fa755a'
        }
      }
    
      // Create an instance of the card Element and apply the style
      var card = stripe.elements().create('card', { style: style })
    
      // Mount the card element to the DOM
      card.mount('#card-element')
    })
  </script>
{% endblock %}
